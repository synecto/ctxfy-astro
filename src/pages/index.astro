---
import groq from "groq";
import Layout from "../layouts/Layout.astro";
import { sanity } from "../lib/sanity";

const home = await sanity.fetch(groq`*[_type=="homePage"][0]{
  title,
  description,
  hero{
    headline, subheadline,
    microProof,
    primaryCta{label, href},
    secondaryCta{label, href}
  },
  valueCards[]{title, description},
  featuredUseCases[]->{
    title,
    "slug": slug.current,
    heroHeadline,
    subheadline,
    stakes,
    timeToValue,
    proofPoints,
    momentBullets
  },
  howItWorks[]{title, description},
  evidence[]{type, claim, measurement, href},
  faq[]{q, a},
  finalCta{
    headline, subheadline,
    primaryCta{label, href},
    secondaryCta{label, href}
  }
}`);

const fallbackUseCases = await sanity.fetch(groq`*[_type=="useCase" && defined(slug.current)]
| order(_createdAt desc)[0...6]{
  title,
  "slug": slug.current,
  heroHeadline,
  subheadline,
  stakes,
  timeToValue,
  proofPoints,
  momentBullets
}`);

const featured = (home?.featuredUseCases?.length ? home.featuredUseCases : fallbackUseCases) || [];

function safe(s?: string) {
	return (s ?? "").trim();
}
---

<Layout title={home?.title ?? "Home"} description={home?.description}>
	<main class="home">
		<!-- HERO -->
		<section class="hero">
			<div class="hero-copy">
				<h1>{home?.hero?.headline ?? "Stop guessing why your RAG failed."}</h1>
				<p class="sub">
					{home?.hero?.subheadline ??
						"Trace retrieval → context → output. Find the exact chunk that caused hallucinations and fix it fast."}
				</p>

				<div class="cta-row">
					<a class="btn primary" href={home?.hero?.primaryCta?.href ?? "/signup"}>
						{home?.hero?.primaryCta?.label ?? "Try free"}
					</a>

					{home?.hero?.secondaryCta?.href ? (
						<a class="btn ghost" href={home.hero.secondaryCta.href}>
							{home.hero.secondaryCta.label ?? "See example"}
						</a>
					) : (
						<a class="btn ghost" href="/use-cases/">
							Browse use cases
						</a>
					)}
				</div>

				{home?.hero?.microProof?.length ? (
					<ul class="micro-proof">
						{home.hero.microProof.slice(0, 4).map((p: string) => <li>{p}</li>)}
					</ul>
				) : (
					<ul class="micro-proof">
						<li>Full provenance: every claim linked to a source</li>
						<li>Find conflicts + missing evidence before users do</li>
						<li>Compare runs: “why did it work yesterday?”</li>
					</ul>
				)}
			</div>

			<div class="hero-panel">
				<div class="panel">
					<div class="panel-title">Context Trace (preview)</div>
					<div class="panel-row"><span class="k">Query</span><span class="v">“What’s our refund policy?”</span></div>
					<div class="panel-row"><span class="k">Top chunk</span><span class="v">Archived doc (2022) ❌</span></div>
					<div class="panel-row"><span class="k">Conflict</span><span class="v">Policy v3 vs v5 ⚠️</span></div>
					<div class="panel-row"><span class="k">Fix</span><span class="v">Exclude archived sources ✅</span></div>
					<div class="panel-foot">Replace screenshot later with real UI.</div>
				</div>
			</div>
		</section>

		<!-- VALUE CARDS -->
		<section class="section">
			<h2>What you get</h2>
			<div class="grid">
				{(home?.valueCards?.length ? home.valueCards : [
					{ title: "Explain failures", description: "See exactly which chunk influenced the answer, with provenance." },
					{ title: "Detect conflicts", description: "Highlight contradictory chunks and outdated sources automatically." },
					{ title: "Compare runs", description: "Understand regressions: what changed between successful and failing runs." },
					{ title: "Move faster", description: "Reduce time-to-root-cause and stop blind prompt tweaking." },
				]).map((c: any) => (
					<article class="card">
						<h3>{c.title}</h3>
						<p>{c.description}</p>
					</article>
				))}
			</div>
		</section>

		<!-- FEATURED USE CASES -->
		<section class="section">
			<div class="section-head">
				<h2>Pick your moment</h2>
				<a class="link" href="/use-cases/">Browse all →</a>
			</div>

			<div class="uc-grid">
				{featured.slice(0, 6).map((uc: any) => (
					<a class="uc-card" href={`/use-cases/${uc.slug}/`}>
						<div class="uc-meta">
							<span class={`badge stake-${uc.stakes || "unknown"}`}>{uc.stakes || "unknown"}</span>
							{uc.timeToValue ? <span class="ttv">TTFV: {uc.timeToValue}</span> : null}
						</div>
						<h3>{uc.title}</h3>
						{uc.heroHeadline ? <p class="uc-h">{uc.heroHeadline}</p> : null}
						{uc.momentBullets?.length ? (
							<ul class="uc-b">
								{uc.momentBullets.slice(0, 3).map((b: string) => <li>{b}</li>)}
							</ul>
						) : (
							<p class="muted">Add moment bullets in Sanity.</p>
						)}
						<div class="uc-foot">
							{uc.proofPoints?.length ? <span class="muted">{uc.proofPoints[0]}</span> : <span class="muted">Open →</span>}
						</div>
					</a>
				))}
			</div>
		</section>

		<!-- EVIDENCE -->
		{home?.evidence?.length ? (
			<section class="section">
				<h2>Proof</h2>
				<div class="grid">
					{home.evidence.slice(0, 4).map((e: any) => (
						<article class="card">
							<div class="meta">{e.type}</div>
							<h3>{e.claim}</h3>
							{e.measurement ? <p class="muted">{e.measurement}</p> : null}
							{e.href ? <a class="link" href={e.href}>View →</a> : null}
						</article>
					))}
				</div>
			</section>
		) : null}

		<!-- HOW IT WORKS -->
		{home?.howItWorks?.length ? (
			<section class="section">
				<h2>How it works</h2>
				<ol class="steps">
					{home.howItWorks.map((s: any) => (
						<li class="step">
							<strong>{s.title}</strong>
							<p class="muted">{s.description}</p>
						</li>
					))}
				</ol>
			</section>
		) : null}

		<!-- FAQ -->
		{home?.faq?.length ? (
			<section class="section">
				<h2>FAQ</h2>
				<div class="faq">
					{home.faq.slice(0, 6).map((f: any) => (
						<details class="faq-item">
							<summary>{f.q}</summary>
							<p class="muted">{f.a}</p>
						</details>
					))}
				</div>
			</section>
		) : null}

		<!-- FINAL CTA -->
		<section class="final">
			<h2>{home?.finalCta?.headline ?? "Ship reliable RAG faster."}</h2>
			{home?.finalCta?.subheadline ? <p class="muted">{home.finalCta.subheadline}</p> : null}

			<div class="cta-row">
				<a class="btn primary" href={home?.finalCta?.primaryCta?.href ?? "/signup"}>
					{home?.finalCta?.primaryCta?.label ?? "Try free"}
				</a>

				{home?.finalCta?.secondaryCta?.href ? (
					<a class="btn ghost" href={home.finalCta.secondaryCta.href}>
						{home.finalCta.secondaryCta.label ?? "See example"}
					</a>
				) : (
					<a class="btn ghost" href="/use-cases/">Browse use cases</a>
				)}
			</div>
		</section>
	</main>

	<style>
		.home { max-width: 1100px; margin: 0 auto; padding: 28px 20px 72px; }
		.hero { display: grid; gap: 18px; align-items: start; grid-template-columns: 1fr; padding: 18px 0 10px; }
		@media (min-width: 960px) { .hero { grid-template-columns: 1.2fr 0.8fr; } }

		h1 { font-size: 44px; line-height: 1.05; margin: 0 0 10px; }
		.sub { margin: 0 0 14px; opacity: 0.85; max-width: 70ch; font-size: 18px; }

		.cta-row { display: flex; gap: 10px; flex-wrap: wrap; margin: 10px 0 12px; }
		.btn { display: inline-flex; align-items: center; justify-content: center; padding: 11px 14px; border-radius: 12px; border: 1px solid rgba(0,0,0,.14); text-decoration: none; color: inherit; font-weight: 600; }
		.btn.primary { border-color: rgba(0,0,0,.35); }
		.btn.ghost { background: transparent; }

		.micro-proof { margin: 10px 0 0; padding-left: 18px; opacity: 0.85; }
		.hero-panel .panel { border: 1px solid rgba(0,0,0,.12); border-radius: 16px; padding: 14px; }
		.panel-title { font-weight: 700; margin-bottom: 10px; }
		.panel-row { display: flex; gap: 10px; justify-content: space-between; padding: 8px 0; border-top: 1px solid rgba(0,0,0,.06); }
		.panel-row .k { opacity: 0.65; }
		.panel-row .v { font-weight: 600; text-align: right; }
		.panel-foot { margin-top: 10px; opacity: 0.6; font-size: 12px; }

		.section { margin-top: 34px; }
		.section-head { display: flex; justify-content: space-between; align-items: baseline; gap: 12px; }
		h2 { margin: 0 0 12px; font-size: 26px; }
		.link { text-decoration: none; border-bottom: 1px solid rgba(0,0,0,.2); color: inherit; }

		.grid { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 12px; }
		@media (min-width: 760px) { .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }

		.card { border: 1px solid rgba(0,0,0,.12); border-radius: 16px; padding: 14px; }
		.card h3 { margin: 6px 0 6px; }
		.meta { font-size: 12px; opacity: 0.6; text-transform: uppercase; letter-spacing: .02em; }

		.uc-grid { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 12px; }
		@media (min-width: 760px) { .uc-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
		@media (min-width: 1040px) { .uc-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }

		.uc-card { border: 1px solid rgba(0,0,0,.12); border-radius: 16px; padding: 14px; text-decoration: none; color: inherit; display: grid; gap: 10px; }
		.uc-card:hover { background: rgba(0,0,0,.02); }
		.uc-meta { display: flex; gap: 10px; align-items: center; }
		.badge { font-size: 12px; padding: 4px 8px; border-radius: 999px; border: 1px solid rgba(0,0,0,.14); }
		.ttv { font-size: 12px; opacity: 0.7; }
		.uc-h { margin: 0; font-weight: 650; opacity: 0.9; }
		.uc-b { margin: 0; padding-left: 18px; opacity: 0.85; }
		.uc-foot { margin-top: 6px; }
		.muted { opacity: 0.75; }

		.steps { margin: 0; padding-left: 18px; display: grid; gap: 10px; }
		.step strong { display: inline-block; margin-bottom: 4px; }

		.faq { display: grid; gap: 10px; }
		.faq-item { border: 1px solid rgba(0,0,0,.12); border-radius: 14px; padding: 10px 12px; }
		summary { cursor: pointer; font-weight: 700; }

		.final { margin-top: 46px; border: 1px solid rgba(0,0,0,.12); border-radius: 18px; padding: 18px; }
	</style>
</Layout>
