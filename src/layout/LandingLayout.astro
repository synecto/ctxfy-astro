---
import LandingNav from "@sections/LandingNav.astro";
import LandingFooter from "@sections/LandingFooter.astro";

type Props = {
  title?: string;
  description?: string;
  canonical?: string;
  noindex?: boolean;
};

const {
  title = "Ctxfy",
  description = "Communicate. Collaborate. Create.",
  canonical,
  noindex = false,
} = Astro.props;

// Public env vars (Astro exposes only PUBLIC_*)
const AMPLITUDE_API_KEY = import.meta.env.PUBLIC_AMPLITUDE_API_KEY;
const GROWTHBOOK_CLIENT_KEY = import.meta.env.PUBLIC_GROWTHBOOK_CLIENT_KEY;
const GROWTHBOOK_API_HOST =
  import.meta.env.PUBLIC_GROWTHBOOK_API_HOST || "https://cdn.growthbook.io";
const APP_ENV = import.meta.env.PUBLIC_APP_ENV || "development";

const url = Astro.url;
const canonicalUrl = canonical ? canonical : `${url.origin}${url.pathname}`;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalUrl} />

    {noindex ? <meta name="robots" content="noindex,nofollow" /> : null}

    <title>{title}</title>

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Google+Sans:ital,opsz,wght@0,17..18,400..700;1,17..18,400..700&family=Zalando+Sans+SemiExpanded:ital,wght@0,200..900;1,200..900&display=swap"
      rel="stylesheet"
    />

    <style is:global>
      :root {
        color-scheme: light;
        --landing-bg: #ffffff;
        --landing-surface: #ffffff;
        --landing-ink: #111111;
        --landing-muted: #6f6f6f;
        --landing-accent: #f2b32a;
        --landing-accent-strong: #f4c243;
        --landing-pink: #f9d3e6;
        --landing-border: #1a1a1a;
        --landing-card: #fefefe;
        --landing-shadow: 0 24px 50px -36px rgba(0, 0, 0, 0.35);
        --landing-font: "DM Sans", "Work Sans", ui-sans-serif, system-ui;
        --nav-bg: #ffffff;
        --mega-bg: #f7f7f7;
      }

      /* Dark theme deactivated for now
      @media (prefers-color-scheme: dark) {
        :root {
          --landing-bg: #0a0a0a;
          --landing-surface: #111111;
          --landing-ink: #f9f7f4;
          --landing-muted: #a1a1a1;
          --landing-border: #333333;
          --landing-card: #1a1a1a;
          --landing-shadow: 0 24px 50px -36px rgba(0, 0, 0, 0.7);
          --landing-pink: #2a1a24;
          --nav-bg: #111111;
          --mega-bg: #1a1a1a;
        }
      }
      */

      html {
        scroll-behavior: smooth;
        scroll-snap-type: y mandatory;
      }

      .google-sans {
        font-family: "Google Sans", sans-serif;
        font-optical-sizing: auto;
        font-style: normal;
        font-variation-settings: "GRAD" 0;
      }

      * {
        box-sizing: border-box;
        font-family: "Google Sans", sans-serif;
      }

      body.landing-body {
        margin: 0;
        font-family: var(--landing-font);
        background: var(--landing-bg);
        color: var(--landing-ink);
      }

      #home > section,
      .footer {
        scroll-snap-align: start;
        scroll-snap-stop: always;
      }

      #home > section {
        min-height: calc(100vh);
        display: grid;
        align-items: center;
        padding-top: 20px;
        padding-bottom: 20px;
      }
      img,
      svg {
        max-width: 100%;
        display: block;
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      .landing {
        border-top: 8px solid var(--landing-ink);
        background: var(--landing-surface);
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 28px;
      }

      .nav-wrapper {
        background: var(--nav-bg);
        position: sticky;
        top: 0;
        z-index: 50;
      }

      .nav-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 24px;
        padding: 20px 40px;
        margin: 0 auto;
        position: relative;
        max-width: 1600px;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 700;
        letter-spacing: 0.01em;
      }

      .brand-badge {
        width: 34px;
        height: 34px;
        border-radius: 8px;
        background: var(--landing-ink);
        color: var(--landing-surface);
        display: grid;
        place-items: center;
        font-size: 18px;
      }

      .brand-sub {
        display: block;
        font-size: 12px;
        font-weight: 500;
        color: var(--landing-muted);
        margin-top: 2px;
      }

      .nav-links {
        display: flex;
        align-items: center;
        gap: 14px;
        font-size: 14px;
        color: var(--landing-muted);
      }

      .nav-group {
        display: flex;
        align-items: center;
        gap: 28px;
        flex: 1;
        justify-content: space-between;
      }

      .nav-link,
      .nav-trigger,
      .nav-login {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border-radius: 999px;
        color: var(--landing-muted);
        font-weight: 600;
        transition:
          transform 200ms ease,
          box-shadow 200ms ease,
          background 200ms ease,
          color 200ms ease;
      }

      .nav-link:hover,
      .nav-trigger:hover,
      .nav-login:hover {
        background: var(--landing-bg);
        color: var(--landing-ink);
      }

      .nav-item {
        position: relative;
      }

      .nav-item.has-mega {
        position: relative;
      }

      .nav-trigger {
        border: none;
        background: none;
        cursor: pointer;
        font: inherit;
      }

      .nav-caret {
        font-size: 12px;
        transition: transform 200ms ease;
      }

      .nav-item.has-mega:hover .nav-caret,
      .nav-item.has-mega:focus-within .nav-caret {
        transform: rotate(180deg);
      }

      .mega-menu {
        position: absolute;
        top: calc(100% + 8px);
        left: 50%;
        transform: translate(-50%, 0);
        width: min(1100px, 92vw);
        background: var(--mega-bg);
        border: 2px solid var(--landing-border);
        border-radius: 28px;
        padding: 22px;
        box-shadow: var(--landing-shadow);
        opacity: 0;
        pointer-events: none;
        transition:
          opacity 180ms ease,
          transform 200ms ease;
        z-index: 60;
      }

      .mega-menu::before {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        top: -20px;
        height: 20px;
      }

      .nav-item.has-mega:hover .mega-menu,
      .nav-item.has-mega:focus-within .mega-menu {
        opacity: 1;
        pointer-events: auto;
        transform: translate(-50%, 0);
      }

      /* Ensure content doesn't overlap with sticky nav */
      main {
        position: relative;
        z-index: 1;
      }

      .mega-panel {
        display: grid;
        grid-template-columns: minmax(240px, 1fr) 3fr;
        gap: 26px;
        align-items: stretch;
      }

      .mega-card {
        border-radius: 22px;
        padding: 22px;
        color: #fff;
        background: radial-gradient(
          circle at 20% 20%,
          rgba(97, 131, 255, 0.9),
          rgba(30, 48, 116, 0.95) 45%,
          #0b0b0b 100%
        );
        border: 2px solid #0f1b2d;
        display: flex;
        flex-direction: column;
        gap: 18px;
        min-height: 260px;
      }

      .mega-card-art {
        height: 120px;
        border-radius: 16px;
        background: linear-gradient(135deg, #202a5e, #4a5bff, #a076ff);
        border: 2px solid rgba(255, 255, 255, 0.2);
      }

      .mega-card-title {
        font-size: 20px;
        font-weight: 600;
        margin: 0 0 6px;
      }

      .mega-card-copy {
        margin: 0;
        font-size: 13px;
        color: rgba(255, 255, 255, 0.7);
      }

      .mega-card-link {
        color: #fff;
        font-weight: 600;
        font-size: 14px;
      }

      .mega-columns {
        display: grid;
        grid-template-columns: repeat(4, minmax(160px, 1fr));
        gap: 22px;
      }

      .mega-col-title {
        font-size: 12px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--landing-muted);
        margin: 0 0 12px;
        font-weight: 700;
      }

      .mega-link {
        display: flex;
        flex-direction: column;
        gap: 4px;
        padding: 6px 0;
        color: var(--landing-ink);
      }

      .mega-link-title {
        font-size: 14px;
        font-weight: 600;
        color: #111;
      }

      .mega-link-desc {
        font-size: 12px;
        color: var(--landing-muted);
      }

      .nav-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .nav-login {
        color: #111;
      }

      .nav-pill {
        padding: 8px 16px;
        border: 2px solid var(--landing-border);
        border-radius: 999px;
        font-weight: 700;
        background: #fff;
        transition:
          transform 200ms ease,
          box-shadow 200ms ease;
      }

      .nav-pill.primary {
        background: var(--landing-ink);
        color: var(--landing-surface);
        border-color: var(--landing-ink);
      }

      .nav-cta {
        padding: 8px 14px;
        border: 2px solid var(--landing-border);
        border-radius: 8px;
        font-weight: 700;
        background: var(--landing-accent-strong);
      }

      .hero {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 28px;
        padding: 200px 40px 200px;
        align-items: center;
      }

      .hero h1 {
        font-size: clamp(36px, 4vw, 52px);
        line-height: 1.05;
        margin: 0 0 16px;
        font-weight: 400;
        margin-bottom: 130px;
      }

      .hero p {
        color: var(--landing-muted);
        max-width: 420px;
        margin: 0 0 18px;
      }

      .btn-primary {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 18px;
        border-radius: 8px;
        background: var(--landing-ink);
        color: var(--landing-surface);
        font-weight: 700;
        border: 2px solid var(--landing-ink);
      }

      .feature-row {
        margin-top: 26px;
        display: flex;
        gap: 22px;
        flex-wrap: wrap;
      }

      .feature-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--landing-muted);
      }

      .feature-icon {
        width: 24px;
        height: 24px;
        border: 2px solid var(--landing-border);
        border-radius: 6px;
        display: grid;
        place-items: center;
      }

      .hero-art {
        position: relative;
        display: grid;
        place-items: center;
      }

      .hero-card {
        width: min(100%, 360px);
        background: var(--landing-card);
        border: 2px solid var(--landing-border);
        border-radius: 22px;
        padding: 22px 24px 28px;
        box-shadow: var(--landing-shadow);
        transition:
          transform 300ms ease,
          box-shadow 300ms ease;
      }

      .hero-stack {
        display: grid;
        gap: 16px;
      }

      .hero-stack .block {
        height: 46px;
        border-radius: 12px;
        border: 2px solid var(--landing-border);
        background: #f4f1ec;
      }

      .hero-stack .block.alt {
        background: var(--landing-ink);
      }

      .section {
        padding: 64px 0;
      }

      .section-title {
        font-size: 28px;
        margin: 0 0 12px;
      }

      .section-copy {
        color: var(--landing-muted);
        max-width: 520px;
        margin: 0 0 26px;
      }

      .offer-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 28px;
      }

      .offer-card {
        background: var(--landing-card);
        border: 2px solid var(--landing-border);
        border-radius: 16px;
        padding: 18px;
        display: grid;
        gap: 14px;
        transition:
          transform 250ms ease,
          box-shadow 250ms ease;
      }

      .offer-art {
        height: 150px;
        border-radius: 14px;
        border: 2px solid var(--landing-border);
        background: linear-gradient(135deg, #f2c44e, #f3a3c6, #7ed7b9);
      }

      .offer-title {
        font-weight: 700;
        margin: 0;
      }

      .offer-text {
        font-size: 13px;
        color: var(--landing-muted);
        margin: 0;
      }

      .split {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 36px;
        align-items: center;
      }

      .illustration-card {
        height: 320px;
        border: 2px solid var(--landing-border);
        border-radius: 24px;
        background: #fdf6ff;
        position: relative;
        overflow: hidden;
      }

      .illustration-card::before {
        content: "";
        position: absolute;
        inset: 18px 32px auto auto;
        width: 110px;
        height: 110px;
        border-radius: 50%;
        background: #cfe8ff;
      }

      .illustration-card::after {
        content: "";
        position: absolute;
        inset: auto 26px 24px 18px;
        height: 120px;
        border-radius: 18px;
        background: #ffe3b3;
      }

      .trusted {
        background: var(--landing-pink);
      }

      .logo-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 22px;
        margin-top: 28px;
      }

      .logo-badge {
        border: 2px solid var(--landing-border);
        border-radius: 12px;
        padding: 18px 14px;
        text-align: center;
        font-weight: 700;
        background: var(--landing-card);
        transition:
          transform 220ms ease,
          box-shadow 220ms ease;
      }

      .testimonial-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 26px;
      }

      .testimonial-card {
        border: 2px solid var(--landing-border);
        border-radius: 14px;
        overflow: hidden;
        background: var(--landing-card);
        display: grid;
        gap: 12px;
        padding: 0 0 18px;
        transition:
          transform 220ms ease,
          box-shadow 220ms ease;
      }

      .testimonial-header {
        background: var(--landing-accent-strong);
        border-bottom: 2px solid var(--landing-border);
        padding: 10px 14px;
        font-weight: 700;
      }

      .testimonial-body {
        padding: 0 16px;
        color: var(--landing-muted);
        font-size: 13px;
      }

      .testimonial-author {
        padding: 0 16px;
        font-weight: 700;
        font-size: 13px;
      }

      .pricing {
        background: #f7f4f0;
      }

      .pricing-card {
        border: 2px solid var(--landing-border);
        border-radius: 16px;
        overflow: hidden;
        background: var(--landing-ink);
        color: var(--landing-surface);
      }

      .pricing-top {
        padding: 24px;
        border-bottom: 2px solid var(--landing-border);
      }

      .pricing-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 8px;
        background: var(--landing-accent-strong);
        color: #111;
        font-size: 12px;
        font-weight: 700;
        margin-bottom: 12px;
      }

      .pricing-bottom {
        background: var(--landing-pink);
        color: #111;
        padding: 20px;
        display: grid;
        gap: 10px;
      }

      .pricing-line {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
      }

      .cta-section {
        background: #fff;
        text-align: center;
        padding: 72px 0 0;
      }

      .cta-section h2 {
        margin: 0 0 14px;
        font-size: 30px;
      }

      .cta-illustration {
        margin: 36px auto 0;
        height: 260px;
        max-width: 720px;
        border: 2px solid var(--landing-border);
        border-radius: 24px 24px 0 0;
        background: linear-gradient(180deg, #d9ebff 0%, #f6f0ff 60%, #fff 100%);
        position: relative;
        overflow: hidden;
      }

      .cta-illustration::after {
        content: "";
        position: absolute;
        inset: auto 0 0 0;
        height: 44px;
        background: var(--landing-accent);
      }

      .footer {
        background: var(--landing-accent);
        padding: 50px 0 20px;
      }

      .footer-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 28px;
        color: #111;
      }

      .footer-title {
        font-weight: 700;
        margin-bottom: 10px;
      }

      .footer-note {
        font-size: 13px;
        color: #272727;
      }

      .footer-bottom {
        margin-top: 28px;
        border-top: 2px solid var(--landing-border);
        padding-top: 16px;
        text-align: center;
        font-size: 12px;
        color: #222;
      }

      .input {
        border: 2px solid var(--landing-border);
        border-radius: 8px;
        padding: 8px 10px;
        background: var(--landing-card);
        color: var(--landing-ink);
        width: 100%;
      }

      .footer-btn {
        margin-top: 10px;
        padding: 10px 16px;
        background: #111;
        color: #fff;
        border-radius: 8px;
        border: 2px solid #111;
        font-weight: 700;
        transition:
          transform 200ms ease,
          box-shadow 200ms ease;
      }

      .nav-cta,
      .btn-primary,
      .nav-pill {
        transition:
          transform 200ms ease,
          box-shadow 200ms ease;
      }

      .nav-cta:hover,
      .btn-primary:hover,
      .footer-btn:hover,
      .nav-pill:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 24px -18px rgba(0, 0, 0, 0.45);
      }

      .offer-card:hover,
      .testimonial-card:hover,
      .logo-badge:hover {
        transform: translateY(-4px);
        box-shadow: 0 18px 30px -24px rgba(0, 0, 0, 0.45);
      }

      .hero-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 26px 60px -36px rgba(0, 0, 0, 0.45);
      }

      .reveal {
        opacity: 0;
        transform: translateY(18px);
        transition:
          opacity 700ms ease,
          transform 700ms ease;
        will-change: opacity, transform;
      }

      .reveal.is-visible {
        opacity: 1;
        transform: translateY(0);
      }

      .reveal.fade {
        transform: none;
      }

      .reveal.slide-left {
        transform: translateX(-24px);
      }

      .reveal.slide-right {
        transform: translateX(24px);
      }

      .reveal.zoom {
        transform: scale(0.94);
      }

      .reveal.is-visible.slide-left,
      .reveal.is-visible.slide-right,
      .reveal.is-visible.zoom {
        transform: translateX(0) scale(1);
      }

      .parallax {
        transform: translateY(var(--parallax-offset, 0px));
        transition: transform 120ms linear;
        will-change: transform;
      }

      @media (prefers-reduced-motion: reduce) {
        .reveal,
        .parallax,
        .nav-cta,
        .btn-primary,
        .footer-btn,
        .offer-card,
        .testimonial-card,
        .logo-badge,
        .hero-card {
          transition: none;
          transform: none;
        }
      }

      @media (max-width: 920px) {
        .landing {
          margin: 14px;
        }

        .hero,
        .split {
          grid-template-columns: 1fr;
        }

        .nav-links {
          display: none;
        }

        .nav-actions {
          display: none;
        }
      }

      @media (max-width: 1100px) {
        .mega-panel {
          grid-template-columns: 1fr;
        }

        .mega-card {
          min-height: 220px;
        }

        .mega-columns {
          grid-template-columns: repeat(2, minmax(180px, 1fr));
        }
      }
    </style>

    <!-- Runtime config exposed for client scripts -->
    <script
      is:inline
      define:vars={{
        AMPLITUDE_API_KEY,
        GROWTHBOOK_CLIENT_KEY,
        GROWTHBOOK_API_HOST,
        APP_ENV,
      }}
    >
      window.__APP__ = {
        env: { APP_ENV: APP_ENV },
        amplitude: { apiKey: AMPLITUDE_API_KEY || "" },
        growthbook: {
          clientKey: GROWTHBOOK_CLIENT_KEY,
          apiHost: GROWTHBOOK_API_HOST,
        },
      };
    </script>

    <!-- Analytics + Experiments (Amplitude + GrowthBook) -->
    <script type="module">
      const cfg = window.__APP__ || {};
      const page = {
        path: location.pathname,
        href: location.href,
        referrer: document.referrer || null,
        title: document.title,
      };

      // 1) Amplitude
      async function initAmplitude() {
        const key = cfg?.amplitude?.apiKey;
        if (!key) return null;

        try {
          const mod = await import("@amplitude/analytics-browser");
          mod.init(key, undefined, {
            defaultTracking: {
              pageViews: true,
              sessions: true,
              formInteractions: true,
            },
            logLevel: cfg?.env?.APP_ENV === "production" ? "WARN" : "INFO",
          });

          // expose helper
          window.track = (event, props = {}) =>
            mod.track(event, { ...props, ...page });
          window.track("page_view", { source: "layout" });

          return mod;
        } catch (e) {
          console.warn("Amplitude init failed", e);
          return null;
        }
      }

      // 2) GrowthBook
      async function initGrowthBook() {
        const clientKey = cfg?.growthbook?.clientKey;
        const apiHost = cfg?.growthbook?.apiHost;
        if (!clientKey || !apiHost) return null;

        try {
          const { GrowthBook } = await import("@growthbook/growthbook");

          const gb = new GrowthBook({
            apiHost,
            clientKey,
            enableDevMode: cfg?.env?.APP_ENV !== "production",
            trackingCallback: (experiment, result) => {
              window.track?.("experiment_viewed", {
                experimentKey: experiment.key,
                variationId: result.variationId,
              });
            },
          });

          // Basic attributes (expand later: logged-in userId, plan, etc.)
          gb.setAttributes({
            path: location.pathname,
            referrer: document.referrer || "",
            utm_source:
              new URLSearchParams(location.search).get("utm_source") || "",
            utm_campaign:
              new URLSearchParams(location.search).get("utm_campaign") || "",
          });

          await gb.loadFeatures({ timeout: 1500 });
          window.growthbook = gb;

          return gb;
        } catch (e) {
          console.warn("GrowthBook init failed", e);
          return null;
        }
      }

      // 3) Track clicks on anything with data-track
      function initClickTracking() {
        document.addEventListener("click", (e) => {
          const el = e.target?.closest?.("[data-track]");
          if (!el) return;

          const event = el.getAttribute("data-track");
          const propsRaw = el.getAttribute("data-track-props");
          let props = {};
          try {
            props = propsRaw ? JSON.parse(propsRaw) : {};
          } catch {
            // No-op: malformed JSON props
          }

          window.track?.(event, {
            ...props,
            text: (el.textContent || "").trim().slice(0, 80),
            href: el.getAttribute("href") || null,
          });
        });
      }

      // 4) Reveal animations
      function initRevealAnimations() {
        const items = document.querySelectorAll(".reveal");
        if (!("IntersectionObserver" in window)) {
          items.forEach((el) => el.classList.add("is-visible"));
          return;
        }

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                entry.target.classList.add("is-visible");
                observer.unobserve(entry.target);
              }
            });
          },
          { threshold: 0.12 },
        );

        items.forEach((el) => observer.observe(el));
      }

      // 5) Simple parallax for marked elements
      function initParallax() {
        const items = Array.from(document.querySelectorAll("[data-parallax]"));
        if (!items.length) return;

        const update = () => {
          const y = window.scrollY || 0;
          items.forEach((el) => {
            const speed = Number(el.getAttribute("data-parallax")) || 0.1;
            const offset = Math.round(y * speed);
            el.style.setProperty("--parallax-offset", `${offset}px`);
          });
        };

        update();
        window.addEventListener("scroll", update, { passive: true });
      }

      await initAmplitude();
      await initGrowthBook();
      initClickTracking();
      initRevealAnimations();
      initParallax();
    </script>
  </head>

  <body class="landing-body">
    <LandingNav />
    <slot />
    <LandingFooter />
  </body>
</html>
