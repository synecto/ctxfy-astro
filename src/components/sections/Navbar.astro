---
import Support from "@megaMenu/Support.astro";
import Platform from "@megaMenu/Platform.astro";
import Features from "@megaMenu/Features.astro";
import UseCases from "@megaMenu/UseCases.astro";
import Button from "@ui/Button.astro";
import { getNavigationData } from "@lib/query/navigation";

const currentPath = Astro.url.pathname;

// Get navigation data from Sanity
const navigationData = await getNavigationData();

// Fallback to default values if Sanity data is not available
const navigationLinks = navigationData?.primaryLinks || [
  { href: "/about", label: "About" },
  { href: "/contact", label: "Contact" },
];

const primaryCTA = navigationData?.primaryCTA || { 
  text: "Try Free", 
  href: "https://github.com/mearashadowfax/DataNova" 
};
---

<header
  class="sticky top-0 z-50 w-full border-b border-slate-200 bg-white/80 backdrop-blur-md"
>
  <nav
    class="mx-auto flex h-16 max-w-7xl items-center justify-between px-4 sm:px-6 lg:px-8"
  >
    <div class="flex items-center gap-8">
      <a
        class="flex items-center gap-2 text-xl font-bold tracking-tight text-slate-900 focus:outline-hidden"
        href="/"
        aria-label="Ctxfy Logo"
      >
        <svg
          class="size-6"
          viewBox="0 0 75 65"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path d="M37.5 0L75 65H0L37.5 0Z" fill="currentColor"></path>
        </svg>
        <span>Ctxfy</span>
      </a>

      <div class="hidden items-center gap-1 xl:flex" id="main-nav">
        <div id="nav-pill" class="absolute -z-10 rounded-md bg-slate-100 transition-all duration-300 opacity-0 pointer-events-none"></div>
        
        <a
          href="/"
          class={`nav-link px-3 py-1.5 text-sm font-medium text-slate-600 transition-colors hover:text-slate-900 ${
            currentPath === "/" ? "text-slate-900" : ""
          }`}
          aria-current={currentPath === "/" ? "page" : undefined}
        >
          Overview
        </a>

        <div class="nav-link-wrapper">
          <Features />
        </div>

        <div class="nav-link-wrapper">
          <Platform />
        </div>

        <div class="nav-link-wrapper">
          <UseCases />
        </div>

        <div class="nav-link-wrapper">
          <Support />
        </div>

        {
          navigationLinks.map((link) => (
            <a
              href={link.href}
              class={`nav-link px-3 py-1.5 text-sm font-medium text-slate-600 transition-colors hover:text-slate-900 ${
                currentPath === link.href ? "text-slate-900" : ""
              }`}
              aria-current={currentPath === link.href ? "page" : undefined}
            >
              {link.label}
            </a>
          ))
        }
      </div>
    </div>

    <div class="flex items-center gap-3">
      <div class="hidden items-center gap-3 sm:flex">
        <a
          href="/login"
          class="px-3 py-1.5 text-sm font-medium text-slate-600 transition-colors hover:text-slate-900"
        >
          Log In
        </a>
        <Button
          href={primaryCTA.href}
          variant="primary"
          className="rounded-full px-4 py-1.5 text-sm font-medium"
        >
          {primaryCTA.text}
        </Button>
      </div>

      <button
        type="button"
        class="hs-collapse-toggle flex size-9 items-center justify-center rounded-lg border border-slate-200 text-slate-800 hover:bg-slate-100 xl:hidden"
        id="hs-header-base-collapse"
        aria-expanded="false"
        aria-controls="hs-header-base"
        aria-label="Toggle navigation"
        data-hs-collapse="#hs-header-base"
      >
        <svg
          class="size-4 hs-collapse-open:hidden"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          ><line x1="3" x2="21" y1="6" y2="6"></line><line
            x1="3"
            x2="21" y1="12" y2="12"></line><line x1="3" x2="21" y1="18" y2="18"></line></svg
        >
        <svg
          class="hidden size-4 hs-collapse-open:block"
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          ><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg
        >
      </button>
    </div>
  </nav>

  <!-- Mobile Menu -->
  <div
    id="hs-header-base"
    class="hs-collapse hidden grow basis-full overflow-hidden transition-all duration-300 xl:hidden"
    aria-labelledby="hs-header-base-collapse"
  >
    <div class="border-t border-slate-200 bg-white px-4 py-6 space-y-4">
      <div class="flex flex-col gap-2">
        <a href="/" class="px-3 py-2 text-lg font-medium text-slate-900 hover:bg-slate-50 rounded-lg">Overview</a>
        
        <div class="px-3 py-2 text-xs font-semibold uppercase tracking-wider text-slate-400 pt-4">Products</div>
        <a href="/features" class="px-3 py-2 text-base font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-50 rounded-lg">Features</a>
        <a href="/platform" class="px-3 py-2 text-base font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-50 rounded-lg">Platform</a>
        <a href="/use-cases" class="px-3 py-2 text-base font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-50 rounded-lg">Use Cases</a>
        <a href="/support" class="px-3 py-2 text-base font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-50 rounded-lg">Support</a>

        <div class="px-3 py-2 text-xs font-semibold uppercase tracking-wider text-slate-400 pt-4">Company</div>
        {
          navigationLinks.map((link) => (
            <a href={link.href} class="px-3 py-2 text-base font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-50 rounded-lg">
              {link.label}
            </a>
          ))
        }
      </div>

      <div class="pt-6 border-t border-slate-100 flex flex-col gap-3">
        <a href="/login" class="flex items-center justify-center rounded-lg px-4 py-2.5 text-base font-medium text-slate-600 hover:bg-slate-50">Log In</a>
        <Button
          href={primaryCTA.href}
          variant="primary"
          className="w-full py-3"
        >
          {primaryCTA.text}
        </Button>
      </div>
    </div>
  </div>
</header>

<style>
  .nav-link, .nav-link-wrapper :global(button) {
    position: relative;
    z-index: 1;
  }
</style>

<script>
  function initNav() {
    const nav = document.querySelector("#main-nav");
    const pill = document.querySelector("#nav-pill") as HTMLElement;
    const links = document.querySelectorAll(".nav-link, .nav-link-wrapper > div");

    if (!nav || !pill) return;

    links.forEach((link) => {
      link.addEventListener("mouseenter", (e) => {
        const target = e.currentTarget as HTMLElement;
        const rect = target.getBoundingClientRect();
        const navRect = nav.getBoundingClientRect();

        pill.style.width = `${rect.width}px`;
        pill.style.height = `${rect.height}px`;
        pill.style.left = `${rect.left - navRect.left}px`;
        pill.style.top = `${rect.top - navRect.top}px`;
        pill.style.opacity = "1";
      });
    });

    nav.addEventListener("mouseleave", () => {
      pill.style.opacity = "0";
    });
  }

  document.addEventListener("astro:page-load", async () => {
    initNav();
    const preline = await import("preline/preline.js");
    preline.HSStaticMethods.autoInit();
  });
</script>
